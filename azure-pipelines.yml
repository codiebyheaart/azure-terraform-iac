trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: backendServiceArm
    value: 'Azure-Terraform-Connection'
  - name: backendAzureRmResourceGroupName
    value: 'terraform-state-rg'
  - name: backendAzureRmStorageAccountName
    value: 'tfstate767361244'
  - name: backendAzureRmContainerName
    value: 'tfstate'
  - name: backendAzureRmKey
    value: 'terraform.tfstate'
  - name: TF_VERSION
    value: '1.6.6'

stages:
  - stage: Validate
    displayName: 'Terraform Validate'
    jobs:
      - job: ValidateTerraform
        displayName: 'Validate Terraform Configuration'
        steps:
          - task: AzureCLI@2
            displayName: 'Install Terraform & Validate'
            inputs:
              azureSubscription: $(backendServiceArm)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Install Terraform
                wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
                unzip -q terraform_$(TF_VERSION)_linux_amd64.zip
                sudo mv terraform /usr/local/bin/
                terraform version
                
                # Get storage account key
                export ARM_ACCESS_KEY=$(az storage account keys list \
                  --resource-group $(backendAzureRmResourceGroupName) \
                  --account-name $(backendAzureRmStorageAccountName) \
                  --query '[0].value' -o tsv)
                
                # Initialize Terraform
                terraform init \
                  -backend-config="resource_group_name=$(backendAzureRmResourceGroupName)" \
                  -backend-config="storage_account_name=$(backendAzureRmStorageAccountName)" \
                  -backend-config="container_name=$(backendAzureRmContainerName)" \
                  -backend-config="key=$(backendAzureRmKey)"
                
                # Validate
                terraform validate
                
                echo "✅ Terraform configuration is valid!"

  - stage: Plan
    displayName: 'Terraform Plan'
    dependsOn: Validate
    jobs:
      - job: PlanInfrastructure
        displayName: 'Plan Infrastructure Changes'
        steps:
          - task: AzureCLI@2
            displayName: 'Terraform Plan'
            inputs:
              azureSubscription: $(backendServiceArm)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Install Terraform
                wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
                unzip -q terraform_$(TF_VERSION)_linux_amd64.zip
                sudo mv terraform /usr/local/bin/
                
                # Get storage account key
                export ARM_ACCESS_KEY=$(az storage account keys list \
                  --resource-group $(backendAzureRmResourceGroupName) \
                  --account-name $(backendAzureRmStorageAccountName) \
                  --query '[0].value' -o tsv)
                
                # Initialize
                terraform init \
                  -backend-config="resource_group_name=$(backendAzureRmResourceGroupName)" \
                  -backend-config="storage_account_name=$(backendAzureRmStorageAccountName)" \
                  -backend-config="container_name=$(backendAzureRmContainerName)" \
                  -backend-config="key=$(backendAzureRmKey)"
                
                # Plan
                terraform plan -out=tfplan
                
                echo "✅ Terraform plan completed!"
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Plan File'
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/tfplan'
              artifact: 'tfplan'
              publishLocation: 'pipeline'

  - stage: Apply
    displayName: 'Terraform Apply'
    dependsOn: Plan
    condition: succeeded()
    jobs:
      - deployment: DeployInfrastructure
        displayName: 'Deploy Infrastructure'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Terraform Apply'
                  inputs:
                    azureSubscription: $(backendServiceArm)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Install Terraform
                      wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
                      unzip -q terraform_$(TF_VERSION)_linux_amd64.zip
                      sudo mv terraform /usr/local/bin/
                      
                      # Get storage account key
                      export ARM_ACCESS_KEY=$(az storage account keys list \
                        --resource-group $(backendAzureRmResourceGroupName) \
                        --account-name $(backendAzureRmStorageAccountName) \
                        --query '[0].value' -o tsv)
                      
                      # Initialize
                      terraform init \
                        -backend-config="resource_group_name=$(backendAzureRmResourceGroupName)" \
                        -backend-config="storage_account_name=$(backendAzureRmStorageAccountName)" \
                        -backend-config="container_name=$(backendAzureRmContainerName)" \
                        -backend-config="key=$(backendAzureRmKey)"
                      
                      # Apply
                      terraform apply -auto-approve
                      
                      echo "✅ Infrastructure deployed successfully!"

  - stage: Outputs
    displayName: 'Show Outputs'
    dependsOn: Apply
    condition: succeeded()
    jobs:
      - job: ShowOutputs
        displayName: 'Display Terraform Outputs'
        steps:
          - task: AzureCLI@2
            displayName: 'Terraform Output'
            inputs:
              azureSubscription: $(backendServiceArm)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Install Terraform
                wget -q https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
                unzip -q terraform_$(TF_VERSION)_linux_amd64.zip
                sudo mv terraform /usr/local/bin/
                
                # Get storage account key
                export ARM_ACCESS_KEY=$(az storage account keys list \
                  --resource-group $(backendAzureRmResourceGroupName) \
                  --account-name $(backendAzureRmStorageAccountName) \
                  --query '[0].value' -o tsv)
                
                # Initialize
                terraform init \
                  -backend-config="resource_group_name=$(backendAzureRmResourceGroupName)" \
                  -backend-config="storage_account_name=$(backendAzureRmStorageAccountName)" \
                  -backend-config="container_name=$(backendAzureRmContainerName)" \
                  -backend-config="key=$(backendAzureRmKey)"
                
                # Show outputs
                echo "========================================="
                echo "         TERRAFORM OUTPUTS"
                echo "========================================="
                terraform output
                echo "========================================="
